---
title: "interpolation total"
author: "Jessica French"
date: "`r Sys.Date()`"
output: html_document
---
## Purpose

This markdown will interpolate across our whole AOI using IDW (inverse distance weighting). Interpolation can be done either seasonally or by year and season. 

## Set up
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r label = "read in packages"}
library(tidyverse)
library(tmap)
library(terra)
library(sf)
library(gstat)
library(here)
```

```{r label = "set data directory"}
# set data directory to intermediate data folder on tsosie
datadir <- "/capstone/kelpgeomod/old_file_structure/intermediate_data"
```

```{r label = "read in nutrient file"}
# Read in the combined nutrient file
nutrients <- readRDS(file.path(datadir, "/joined_nutrients/joined_nutrients.RDS"))

# read in mask
mask <- rast(file.path(datadir, "/mask/mask_rast.tif"))
```

## Phosphate interpolation

```{r label = "source in functions"}
# source in function that creates a list of data frames by quarter
source(here("01-data-manipulation-scripts/03-data-interpolation/02-functions/02-prep.R"))
source(here("01-data-manipulation-scripts/03-data-interpolation/02-functions/03-implement.R"))
source(here("01-data-manipulation-scripts/03-data-interpolation/02-functions/04-interpolate.R"))
```

```{r label = "phosphate quarters"}
# no need to assign this to anything, assignment is done in the function. 
# use quarters function if interpolating by quarters. 
idw_prep_quarters("phosphate", nutrients)

# use year and quarter if interpolating for each year and quarter. 
idw_prep_year_quarters("phosphate", nutrients)

# creates phosphate_quarter_df_list object
```


```{r label = "create phosphate raster and remove geom"}
# use idw_implement_rasterize.R function to convert each year and quarter to a raster. 
phosphate_year_quarter_raster_all <- idw_implement_rasterize(phosphate_year_quarter_df_list, 
                                                         "phosphate", 
                                                         mask, 
                                                         all = TRUE)

phosphate_year_quarter_raster <- idw_implement_rasterize(phosphate_year_quarter_df_list, 
                                                         "phosphate", 
                                                         mask)
```

## Try the above for year and quarter

```{r label = "year and quarter convert to raster"}

phosphate_no_geom <- idw_implement_no_geom(phosphate_year_quarter_df_list)

phosphate_interp <- idw_interpolate(phosphate_no_geom, "phosphate", mask)

plot(phosphate_interp[[1]])
```


```{r label = "phosphate IDW"}

phosphate_formula_list <- list()
# loop to define formula
for (i in seq_along(phosphate_no_geom_list)) {
  #formula_name <- paste0("phosphate_form_", i)
  formula <- gstat(formula = phosphate~1,
        locations = ~x+y, 
        data = phosphate_no_geom_list[[i]], 
        nmax = Inf, 
        set = list(idp = 4))
  
  phosphate_formula_list[[i]] <- formula
}


# # Define formula
# gs <- gstat(formula=phosphate~1, 
#             locations=~x+y, 
#             data=phosphate_no_geom_list[[3]], 
#             nmax=Inf, 
#             set=list(idp=4)) # 4 is a litle arbitrary at this point. 



phosphate_interpolate_list <- list()
# loop to interpolate
for (i in seq_along(phosphate_formula_list)) {
  interpolation <- interpolate(phosphate_rast_list[[i]], phosphate_formula_list[[i]], debug.level = 0) |> 
    mask(mask)
  
  phosphate_interpolate_list[[i]] <- interpolation
}

# use terra::interpolate to fill in values in blank raster
# idw <- interpolate(phosphate_rast_list[[3]], gs, debug.level=0)



# apply mask 
# idwr <- mask(idw, mask)
# plot(idwr, 1)

plot(phosphate_interpolate_list[[]], 1)
```

```{r}
write_rds(phosphate_interpolate_list, "/capstone/kelpgeomod/analysis_data/inteprolate_1/phosphate_quarterly.RDS")
```

